name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecución manual desde la interfaz de GitHub

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Descargar el código del repositorio
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Configurar Java (necesario para Android)
    - name: Setup Java JDK
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        
    # 3. Configurar Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools: 33.0.0
        ndk: '25.1.8937393'
        cmake: '3.22.1'
        emulator: false
        
    # 4. Aceptar licencias de Android SDK
    - name: Accept Android Licenses
      run: |
        yes | sdkmanager --licenses || true
        
    # 5. Instalar Cordova CLI
    - name: Install Cordova
      run: |
        npm install -g cordova@12.0.0
        cordova telemetry off
        
    # 6. Preparar el proyecto Cordova
    - name: Setup Cordova Project
      run: |
        # Crear un proyecto Cordova temporal
        cordova create temp-app com.asmet.cbt.academyc "ASMET CBT ACADEMYC"
        cd temp-app
        
        # Copiar tus archivos web a la carpeta www
        cp -r ../www/* www/
        
        # Si existe config.xml, copiarlo
        if [ -f ../config.xml ]; then
          cp ../config.xml .
        fi
        
        # Agregar plataforma Android
        cordova platform add android@12.0.0
        
    # 7. Construir APK en modo debug
    - name: Build Debug APK
      run: |
        cd temp-app
        cordova build android --debug
        echo "✅ APK Debug construida"
        
    # 8. Construir APK en modo release
    - name: Build Release APK
      run: |
        cd temp-app
        cordova build android --release
        echo "✅ APK Release construida"
        
    # 9. Subir las APKs generadas como artefactos
    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ASMET-CBT-APK-Files
        path: |
          temp-app/platforms/android/app/build/outputs/apk/debug/*.apk
          temp-app/platforms/android/app/build/outputs/apk/release/*.apk
        retention-days: 7
        
    # 10. (Opcional) Crear un release en GitHub si se hace tag
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          temp-app/platforms/android/app/build/outputs/apk/release/*.apk
        generate_release_notes: true
