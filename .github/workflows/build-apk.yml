name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # se rellenará por setup-java y setup-android, pero lo dejamos por claridad
      JAVA_HOME: ${{ env.JAVA_HOME }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: |
          platform-tools
          platforms;android-34
          build-tools;34.0.0
          ndk;26.1.10909125
          cmake;3.22.1
        cmdline-tools-version: '11076708'
        accept-android-sdk-licenses: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Cordova CLI
      run: |
        npm install -g cordova@13.0.0
        cordova --version

    - name: Set Android environment variables
      run: |
        # android-actions/setup-android normalmente exporta ANDROID_SDK_ROOT, pero lo guardamos por si acaso
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH" >> $GITHUB_ENV

    - name: Check project structure
      run: |
        echo "Contenido del directorio actual:"
        ls -la
        echo "Contenido de www (si existe):"
        if [ -d "www" ]; then
          ls -la www/
        else
          echo "⚠️ ADVERTENCIA: No existe directorio www/"
          echo "Creando estructura básica..."
          mkdir -p www
          echo "<html><body><h1>App ASMET</h1></body></html>" > www/index.html
        fi

    - name: Create config.xml if missing
      run: |
        if [ ! -f "config.xml" ]; then
          echo "Creando config.xml..."
          cat > config.xml << 'EOF'
<?xml version='1.0' encoding='utf-8'?>
<widget id="com.asmet.cbt.academyc" version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
    <name>ASMET CBT ACADEMYC</name>
    <description>Plataforma de Matemáticas Adaptativa</description>
    <author email="support@asmet.com" href="https://asmet.com">ASMET Team</author>
    <content src="index.html" />
    <access origin="*" />
    <preference name="Orientation" value="portrait" />
    <preference name="Fullscreen" value="false" />
    <preference name="AndroidWindowSplashScreenAnimatedIcon" value="res/screen/android/splash.png" />
    <preference name="android-minSdkVersion" value="24" />
    <preference name="android-targetSdkVersion" value="34" />
    <preference name="android-compileSdkVersion" value="34" />
    <icon src="www/img/icon.png" />
    <edit-config file="app/src/main/AndroidManifest.xml" mode="merge" target="/manifest/application">
        <application android:usesCleartextTraffic="true" />
    </edit-config>
</widget>
EOF
        else
          echo "✓ config.xml ya existe"
        fi

    - name: Install project Node dependencies (if any)
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json, omitiendo npm ci"
        fi

    - name: Setup Cordova project & add Android platform
      run: |
        # Crear proyecto Cordova si no existe (no sobrescribe)
        if [ ! -f config.xml ] || [ ! -d "www" ]; then
          echo "Usando estructura actual o creada previamente"
        fi

        if [ ! -d "platforms" ]; then
          echo "Creando proyecto Cordova (si aplica)..."
          # Si ya hay un proyecto Cordova en el repo, este comando puede no ser necesario
          # cordova create . com.asmet.cbt.academyc "ASMET CBT ACADEMYC"
          echo "Saltando cordova create para evitar sobrescribir archivos (si ya existe)."
        fi

        echo "Agregando plataforma Android (forzar versión compatible)..."
        cordova platform add android@13.0.0 --no-interactive || true

        echo "Preparando proyecto Cordova (instala plugins/configs)..."
        cordova prepare android --no-interactive || true

        echo "Verificando requisitos..."
        cordova requirements android || true

    - name: Prepare release signing (optional)
      if: secrets.ANDROID_KEYSTORE_BASE64 != ''
      run: |
        echo "Decodificando keystore desde secret..."
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release.keystore
        # Mover a carpeta donde Gradle lo lea (ruta relativa a proyecto)
        mkdir -p platforms/android/app
        mv release.keystore platforms/android/app/release.keystore || true

        echo "Creando build.json con credenciales de firma (usando secrets)..."
        cat > build.json <<EOF
{
  "android": {
    "release": {
      "keystore": "platforms/android/app/release.keystore",
      "storePassword": "${{ secrets.KEYSTORE_PASSWORD }}",
      "alias": "${{ secrets.KEY_ALIAS }}",
      "password": "${{ secrets.KEY_PASSWORD }}",
      "keystoreType": ""
    }
  }
}
EOF
        echo "build.json creado"

    - name: Build APKs (debug + release if keys present)
      run: |
        echo "Construyendo APK de debug..."
        cordova build android --debug --no-interactive || exit 0

        if [ -f build.json ]; then
          echo "Construyendo APK de release (firmado usando build.json)..."
          cordova build android --release --buildConfig=build.json --no-interactive -- --packageType=apk || true
        else
          echo "No hay build.json -> se omitirá la build release firmada"
        fi

    - name: List APK files
      run: |
        echo "=== APKs generados ==="
        find platforms/android/app/build/outputs/apk -name "*.apk" -type f -print -exec du -h {} \; || echo "No se encontraron apks"

    - name: Upload APK artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apks
        path: |
          platforms/android/app/build/outputs/apk/**/*.apk
        retention-days: 30

    - name: Upload to GitHub Release (when pushing a tag)
      if: success() && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: platforms/android/app/build/outputs/apk/release/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
