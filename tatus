name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: |
          platform-tools
          platforms;android-33
          build-tools;33.0.0
          ndk;25.1.8937393
          cmake;3.22.1
          emulator
        cmdline-tools-version: '12266719'
        accept-android-sdk-licenses: true
        log-accepted-android-sdk-licenses: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Cordova
      run: |
        npm install -g cordova@12.0.0
        cordova --version

    - name: Prepare project
      run: |
        mkdir -p temp-app/www
        cp -r www/* temp-app/www/

        # Create config.xml if not exists
        if [ ! -f config.xml ]; then
          cat > temp-app/config.xml << 'EOF'
<?xml version='1.0' encoding='utf-8'?>
<widget id="com.asmet.cbt.academyc" version="1.0.0" xmlns="http://www.w3.org/ns/widgets">
    <name>ASMET CBT ACADEMYC</name>
    <description>Plataforma de Matem√°ticas Adaptativa</description>
    <author email="support@asmet.com" href="https://asmet.com">ASMET Team</author>
    <content src="index.html" />
    <preference name="Orientation" value="portrait" />
    <preference name="Fullscreen" value="false" />
    <preference name="android-minSdkVersion" value="22" />
    <preference name="android-targetSdkVersion" value="33" />
    <allow-intent href="http://*/*" />
    <allow-intent href="https://*/*" />
</widget>
EOF
        else
          cp config.xml temp-app/
        fi

    - name: Create Cordova project
      run: |
        cd temp-app
        cordova create . com.asmet.cbt.academyc "ASMET CBT ACADEMYC" --link
        cordova platform add android@12.0.0

    - name: Build Android APK
      run: |
        cd temp-app
        cordova requirements
        cordova build android --debug
        cordova build android --release

    - name: List APK files
      run: |
        find temp-app/platforms/android/app/build/outputs/apk -name "*.apk" -type f

    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: asmet-apk-files
        path: |
          temp-app/platforms/android/app/build/outputs/apk/debug/*.apk
          temp-app/platforms/android/app/build/outputs/apk/release/*.apk
        retention-days: 7
